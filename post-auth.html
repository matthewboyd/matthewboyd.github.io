<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Your PR Logger Account</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg-dark: #020617;
        --bg-surface: #020617;
        --bg-panel: #020617;
        --bg-card: #020617;
        --accent: #6366f1;
        --accent-soft: rgba(99,102,241,0.18);
        --accent-strong: #f97316;
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --border-subtle: rgba(148,163,184,0.35);
        --shadow-soft: 0 24px 60px rgba(15,23,42,0.75);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background:
          radial-gradient(circle at top left, #111827 0, transparent 50%),
          radial-gradient(circle at bottom right, #020617 0, transparent 55%),
          #020617;
        color: var(--text-main);
      }

      .app {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 12px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-mark {
        width: 30px;
        height: 30px;
        border-radius: 12px;
        background:
          conic-gradient(from 180deg at 50% 50%, #6366f1, #ec4899, #f97316, #22c55e, #6366f1);
        padding: 1px;
      }

      .logo-inner {
        width: 100%;
        height: 100%;
        border-radius: 11px;
        background: #020617;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 700;
      }

      .brand-text-main {
        font-size: 16px;
        font-weight: 600;
      }

      .brand-text-sub {
        font-size: 12px;
        color: var(--text-muted);
      }

      .app-pill {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--accent-soft);
        color: var(--accent);
        background: rgba(15,23,42,0.9);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 0.85fr) minmax(0, 1.15fr);
        gap: 16px;
        align-items: flex-start;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        border-radius: 18px;
        background: radial-gradient(circle at top left, #020617, #020617 24%, #020617 100%);
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-soft);
        padding: 16px 16px 16px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 12px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
      }

      .card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .status-badge {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(22,163,74,0.5);
        background: rgba(22,163,74,0.16);
        color: #bbf7d0;
      }

      .status-badge.inactive {
        border-color: rgba(248,113,113,0.6);
        background: rgba(248,113,113,0.14);
        color: #fecaca;
      }

      #status {
        font-size: 13px;
        color: var(--text-main);
        margin-bottom: 10px;
      }

      .btn {
        border-radius: 999px;
        padding: 8px 14px;
        border: 1px solid transparent;
        background: rgba(15,23,42,0.95);
        color: var(--text-main);
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #6366f1, #ec4899);
        border-color: transparent;
        box-shadow: 0 16px 40px rgba(79,70,229,0.55);
      }

      .btn-ghost {
        border-color: rgba(148,163,184,0.6);
      }

      .btn-secondary {
        background: rgba(15,23,42,0.95);
        border-color: rgba(148,163,184,0.6);
      }

      .btn-small {
        padding: 5px 9px;
        font-size: 11px;
      }

      .pill-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 9px;
        border-radius: 999px;
        background: rgba(15,23,42,1);
        border: 1px solid rgba(148,163,184,0.35);
        font-size: 11px;
        color: var(--text-muted);
      }

      pre {
        background: rgba(15,23,42,0.9);
        border-radius: 10px;
        border: 1px solid rgba(148,163,184,0.4);
        padding: 10px 12px;
        font-size: 11px;
        overflow-x: auto;
      }

      #api-key-display {
        margin-top: 12px;
      }

      #debug {
        margin-top: 16px;
      }

      textarea {
        border-radius: 10px;
        border: 1px solid rgba(148,163,184,0.45);
        background: rgba(15,23,42,0.95);
        color: var(--text-main);
        font-size: 13px;
        padding: 10px 12px;
        resize: vertical;
      }

      textarea::placeholder {
        color: rgba(148,163,184,0.9);
      }

      hr {
        border: none;
        border-top: 1px solid rgba(148,163,184,0.25);
        margin: 18px 0;
      }

      #entries-list {
        margin-top: 8px;
        list-style-type: none;
        padding-left: 0;
      }

      #entries-list li {
        font-size: 12px;
      }

      #entries-list li a {
        color: var(--text-main);
      }

      #entries-controls {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 6px;
      }

      #review-output {
        margin-top: 12px;
        max-height: 420px;
        overflow-y: auto;
      }

      .section-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.16em;
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="app-header">
        <div class="brand">
          <div class="logo-mark">
            <div class="logo-inner">PR</div>
          </div>
          <div>
            <div class="brand-text-main">PR AI Evidence Logger</div>
            <div class="brand-text-sub">Your GitHub → performance review bridge</div>
          </div>
        </div>
        <div class="app-pill">
          Logged in via Cognito · Secure by design
        </div>
      </header>

      <div class="grid">
        <!-- Left column: subscription + API key + entries -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Account & subscription</div>
              <div class="card-subtitle">
                Manage billing, API keys and see your captured PR entries.
              </div>
            </div>
            <span id="subscription-badge" class="status-badge inactive">
              Checking…
            </span>
          </div>

          <div id="status"></div>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px;">
            <button id="subscribe-btn" class="btn btn-primary" style="display:none;">
              Start £5/month subscription
            </button>

            <button id="create-api-key-btn" class="btn btn-secondary" style="display:none;">
              Generate API Key
            </button>

            <button id="revoke-api-key-btn" class="btn btn-ghost btn-small" style="display:none;">
              Revoke API Key
            </button>
          </div>

          <div class="section-label">API key</div>
          <pre id="api-key-display">Generate an API key to connect your Chrome extension.</pre>

          <hr />

          <div id="entries-section" style="display: none;">
            <div class="card-header" style="margin-bottom: 8px; padding: 0;">
              <div>
                <div class="card-title" style="font-size: 14px;">Your PR entries</div>
                <div class="card-subtitle">
                  Captured each time you merge or approve a PR this year.
                </div>
              </div>
            </div>

            <div style="display:flex; justify-content: space-between; align-items:center; margin-top:6px;">
              <button id="show-entries-btn" class="btn btn-secondary btn-small">
                Load entries (20 per page)
              </button>
              <div id="entries-controls" style="display:none;">
                <button id="next-page-btn" class="btn btn-ghost btn-small">Next 20</button>
              </div>
            </div>

            <ul id="entries-list" style="margin-top: 10px;"></ul>
          </div>
        </section>

        <!-- Right column: spec + performance review -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Performance review generator</div>
              <div class="card-subtitle">
                Plug in your levels & expectations and let AI assemble the narrative.
              </div>
            </div>
          </div>

          <p id="review-spec-status"></p>

          <div id="spec-upload-container" style="display: none; margin-top: 8px;">
            <p style="font-size: 13px; color: var(--text-muted); margin-top:0;">
              Paste your company’s levels &amp; expectations / performance rubric below.
              We’ll store it privately and use it to map your PR evidence to the right behaviours.
            </p>
            <textarea
              id="spec-text"
              rows="8"
              style="width: 100%; max-width: 100%;"
              placeholder="Example:
L3 Engineer:
- Delivers scoped features independently.
- Writes well-tested, maintainable code...
L4 Engineer:
- Owns end-to-end delivery of complex projects...
(etc.)"
            ></textarea>
            <br />
            <button id="save-spec-btn" class="btn btn-primary" style="margin-top: 8px;">
              Save specification
            </button>
          </div>

          <div id="review-actions" style="display: none; margin-top: 8px;">
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;">
              <button id="generate-review-btn" class="btn btn-primary">
                Generate performance review
              </button>
              <button id="regenerate-review-btn" class="btn btn-ghost btn-small">
                Regenerate with latest entries
              </button>
            </div>
            <div class="pill-inline">
              Tip: update your spec anytime and regenerate to reflect new expectations.
            </div>
          </div>

          <pre id="review-output" style="margin-top: 14px; white-space: pre-wrap;"></pre>
        </section>
      </div>

      <pre id="debug" style="margin-top: 18px; font-size: 11px; opacity: 0.6;"></pre>
    </div>

    <script>
      const apiBase = "https://r2e2xzwttc.execute-api.eu-west-1.amazonaws.com/prod";

      // pagination cursor + month grouping state
      let entriesNextCursor = null;
      let lastRenderedMonthKey = null;

      function parseHash() {
        const raw = window.location.hash.startsWith("#")
          ? window.location.hash.substring(1)
          : window.location.hash;

        const params = new URLSearchParams(raw);
        return {
          idToken: params.get("id_token"),
          accessToken: params.get("access_token"),
          billing: params.get("billing"), // "success" | "cancel" | null
        };
      }

      document.addEventListener("DOMContentLoaded", () => {
        const statusEl = document.getElementById("status");
        const debugEl = document.getElementById("debug");
        const subscribeBtn = document.getElementById("subscribe-btn");
        const apiKeyBtn = document.getElementById("create-api-key-btn");
        const revokeBtn = document.getElementById("revoke-api-key-btn");
        const apiKeyDisplay = document.getElementById("api-key-display");
        const subscriptionBadge = document.getElementById("subscription-badge");

        const entriesSection = document.getElementById("entries-section");
        const showEntriesBtn = document.getElementById("show-entries-btn");
        const entriesControls = document.getElementById("entries-controls");
        const nextPageBtn = document.getElementById("next-page-btn");
        const entriesList = document.getElementById("entries-list");

        const reviewSection = document.getElementById("review-section");
        const reviewSpecStatus = document.getElementById("review-spec-status");
        const specUploadContainer = document.getElementById("spec-upload-container");
        const specText = document.getElementById("spec-text");
        const saveSpecBtn = document.getElementById("save-spec-btn");
        const reviewActions = document.getElementById("review-actions");
        const generateReviewBtn = document.getElementById("generate-review-btn");
        const regenerateReviewBtn = document.getElementById("regenerate-review-btn");
        const reviewOutput = document.getElementById("review-output");

        const { idToken, billing } = parseHash();
        const storedToken = window.localStorage.getItem("idToken");
        let tokenToUse = idToken || storedToken || null;

        // Debug info
        console.log("location.hash:", window.location.hash);
        console.log("idToken from hash:", idToken);
        console.log("idToken from localStorage:", storedToken);
        console.log("billing:", billing);
        debugEl.textContent =
          "hash: " + window.location.hash + "\n" +
          "idToken (hash): " + (idToken || "null") + "\n" +
          "idToken (localStorage): " + (storedToken || "null") + "\n" +
          "billing: " + (billing || "null");

        // Billing status copy
        if (billing === "success") {
          statusEl.textContent =
            "Payment complete – checking subscription status…";
        } else if (billing === "cancel") {
          statusEl.textContent =
            "Payment cancelled. You can retry subscription below.";
        }

        // If we got a fresh token from Cognito, store it
        if (idToken) {
          window.localStorage.setItem("idToken", idToken);
        }

        if (!tokenToUse) {
          statusEl.textContent = "No token found. Please sign in again.";
          subscriptionBadge.textContent = "Not signed in";
          subscriptionBadge.classList.add("inactive");
          return;
        }

        // Use whichever token we found
        initUser(tokenToUse);

        // --- Button handlers ---

        subscribeBtn.addEventListener("click", async () => {
          const token = window.localStorage.getItem("idToken");
          if (!token) {
            alert("No token found, please sign in again.");
            return;
          }

          const res = await fetch(`${apiBase}/billing/create-checkout-session`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({}),
          });

          const data = await res.json().catch(() => ({}));
          console.log("/billing/create-checkout-session response:", data);

          if (!res.ok) {
            alert("Error creating checkout session: " + (data.error || res.status));
            return;
          }

          window.location = data.checkout_url;
        });

        // Generate / show existing key
        apiKeyBtn.addEventListener("click", async () => {
          const token = window.localStorage.getItem("idToken");
          if (!token) {
            alert("No token found, please sign in again.");
            return;
          }

          const res = await fetch(`${apiBase}/apikey`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({ action: "get_or_create" }),
          });

          const data = await res.json().catch(() => ({}));
          console.log("/apikey response:", data);

          if (!res.ok) {
            alert("Error generating API key: " + (data.error || res.status));
            return;
          }

          apiKeyDisplay.textContent =
            "API Key (paste into extension):\n" + data.api_key;
          apiKeyBtn.textContent = "Show API Key";
          revokeBtn.style.display = "inline-block";
        });

        // Revoke key
        revokeBtn.addEventListener("click", async () => {
          const token = window.localStorage.getItem("idToken");
          if (!token) {
            alert("No token found, please sign in again.");
            return;
