<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Your PR Logger Account</title>
  </head>
  <body>
    <h1>Your PR Logger Account</h1>

    <div id="status"></div>

    <button id="subscribe-btn" style="margin-top: 16px; display: none;">
      Start £5/month subscription
    </button>

    <button id="create-api-key-btn" style="margin-top: 16px; display: none;">
      Generate API Key
    </button>

    <pre id="api-key-display" style="margin-top: 16px;"></pre>
    <pre id="debug" style="margin-top: 16px; font-size: 12px; opacity: 0.8;"></pre>

    <script>
      const apiBase = "https://r2e2xzwttc.execute-api.eu-west-1.amazonaws.com/prod";

      function parseHash() {
        const raw = window.location.hash.startsWith("#")
          ? window.location.hash.substring(1)
          : window.location.hash;

        const params = new URLSearchParams(raw);
        return {
          idToken: params.get("id_token"),
          accessToken: params.get("access_token"),
          billing: params.get("billing"), // "success" | "cancel" | null
        };
      }

      document.addEventListener("DOMContentLoaded", () => {
        const statusEl = document.getElementById("status");
        const debugEl = document.getElementById("debug");
        const subscribeBtn = document.getElementById("subscribe-btn");
        const apiKeyBtn = document.getElementById("create-api-key-btn");
        const apiKeyDisplay = document.getElementById("api-key-display");

        const { idToken, billing } = parseHash();
        const storedToken = window.localStorage.getItem("idToken");
        let tokenToUse = idToken || storedToken || null;

        // Debug info so you can see what's happening
        console.log("location.hash:", window.location.hash);
        console.log("idToken from hash:", idToken);
        console.log("idToken from localStorage:", storedToken);
        console.log("billing:", billing);
        debugEl.textContent =
          "hash: " + window.location.hash + "\n" +
          "idToken (hash): " + (idToken || "null") + "\n" +
          "idToken (localStorage): " + (storedToken || "null") + "\n" +
          "billing: " + (billing || "null");

        // Show billing status if present
        if (billing === "success") {
          statusEl.textContent =
            "Payment complete – checking subscription status…";
        } else if (billing === "cancel") {
          statusEl.textContent =
            "Payment cancelled. You can retry subscription below.";
        }

        // If we got a fresh token from Cognito, store it
        if (idToken) {
          window.localStorage.setItem("idToken", idToken);
        }

        if (!tokenToUse) {
          // Really nothing: no hash token, no stored token
          statusEl.textContent =
            "No token found. Please sign in again.";
          return;
        }

        // Use whichever token we found
        initUser(tokenToUse);

        // --- Button handlers ---

        subscribeBtn.addEventListener("click", async () => {
          const token = window.localStorage.getItem("idToken");
          if (!token) {
            alert("No token found, please sign in again.");
            return;
          }

          const res = await fetch(`${apiBase}/billing/create-checkout-session`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({}),
          });

          const data = await res.json().catch(() => ({}));
          console.log("/billing/create-checkout-session response:", data);

          if (!res.ok) {
            alert("Error creating checkout session: " + (data.error || res.status));
            return;
          }

          // Redirect to Stripe Checkout
          window.location = data.checkout_url;
        });

        apiKeyBtn.addEventListener("click", async () => {
          const token = window.localStorage.getItem("idToken");
          if (!token) {
            alert("No token found, please sign in again.");
            return;
          }

          const res = await fetch(`${apiBase}/apikey`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({}),
          });

          const data = await res.json().catch(() => ({}));
          console.log("/apikey response:", data);

          if (!res.ok) {
            alert("Error generating API key: " + (data.error || res.status));
            return;
          }

          apiKeyDisplay.textContent =
            "API Key (paste into extension):\n" + data.api_key;
        });
      });

      async function initUser(token) {
        const statusEl = document.getElementById("status");
        const subscribeBtn = document.getElementById("subscribe-btn");
        const apiKeyBtn = document.getElementById("create-api-key-btn");
        const debugEl = document.getElementById("debug");

        statusEl.textContent = "Loading account...";

        const res = await fetch(`${apiBase}/user/init`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({}),
        });

        const data = await res.json().catch(() => ({}));
        console.log("/user/init response:", data);
        debugEl.textContent +=
          "\n\n/user/init status: " + res.status +
          "\n/user/init body: " + JSON.stringify(data, null, 2);

        if (!res.ok) {
          statusEl.textContent =
            "Error: " + (data.error || res.status);
          return;
        }

        if (data.subscription_status !== "active") {
          statusEl.textContent =
            "Subscription inactive. Click below to start your £5/mo subscription.";
          subscribeBtn.style.display = "inline-block";
          apiKeyBtn.style.display = "none";
        } else {
          statusEl.textContent = "Subscription active.";
          subscribeBtn.style.display = "none";
          apiKeyBtn.style.display = "inline-block";
        }
      }
    </script>
  </body>
</html>
