<script>
  const apiBase = "https://r2e2xzwttc.execute-api.eu-west-1.amazonaws.com/prod";

  function parseHash() {
    const h = window.location.hash.startsWith("#")
      ? window.location.hash.substring(1)
      : window.location.hash;
    const params = new URLSearchParams(h);
    return {
      idToken: params.get("id_token"),
      accessToken: params.get("access_token"),
      billing: params.get("billing"), // success | cancel | null
    };
  }

  const { idToken, billing } = parseHash();

  let tokenToUse = idToken;

  // If we got a fresh token from Cognito, store it
  if (idToken) {
    window.localStorage.setItem("idToken", idToken);
  } else {
    // No token in URL (e.g. after Stripe redirect) – try stored token
    const stored = window.localStorage.getItem("idToken");
    if (stored) {
      tokenToUse = stored;
    }
  }

  // Optional: show billing result somewhere
  if (billing === "success") {
    document.getElementById("status").textContent =
      "Payment complete – checking subscription status…";
  } else if (billing === "cancel") {
    document.getElementById("status").textContent =
      "Payment cancelled. You can retry subscription below.";
  }

  if (!tokenToUse) {
    // Really no token anywhere – user needs to log in again
    document.getElementById("status").textContent =
      "No token found. Please sign in again.";
  } else {
    initUser(tokenToUse);
  }

  async function initUser(token) {
    document.getElementById("status").textContent = "Loading account...";

    const res = await fetch(`${apiBase}/user/init`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({})
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error("user/init error", data);
      document.getElementById("status").textContent =
        "Error: " + (data.error || res.status);
      return;
    }

    if (data.subscription_status !== "active") {
      document.getElementById("status").textContent =
        "Subscription inactive. Click below to start your £5/mo subscription.";
      document.getElementById("subscribe-btn").style.display = "inline-block";
      document.getElementById("create-api-key-btn").style.display = "none";
    } else {
      document.getElementById("status").textContent = "Subscription active.";
      document.getElementById("subscribe-btn").style.display = "none";
      document.getElementById("create-api-key-btn").style.display = "inline-block";
    }
  }

  // existing subscribe-btn / create-api-key-btn handlers stay the same,
  // they rely on localStorage.getItem("idToken") which we now always set on first login.
</script>
