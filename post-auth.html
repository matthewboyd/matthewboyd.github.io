<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RapidReviewer · Post-auth</title>

    <style>
      :root {
        --bg: #0b1220;
        --card: rgba(2, 6, 23, 0.85);
        --card-border: rgba(148, 163, 184, 0.25);
        --text-main: #e5e7eb;
        --text-muted: rgba(148, 163, 184, 0.9);
        --accent: rgb(99, 102, 241);
        --shadow-soft: 0 14px 40px rgba(0, 0, 0, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text-main);
        background: radial-gradient(circle at top left, #0b1220, #050913 55%, #020617);
      }

      a {
        color: inherit;
      }

      .app {
        max-width: 1100px;
        margin: 0 auto;
        padding: 18px 14px 28px;
      }

      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-logo {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        box-shadow: var(--shadow-soft);
      }

      .brand-text-main {
        font-weight: 700;
        font-size: 14px;
        letter-spacing: 0.01em;
      }

      .brand-text-sub {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .app-pill {
        font-size: 12px;
        color: var(--text-muted);
        padding: 8px 10px;
        border: 1px solid var(--card-border);
        background: rgba(15, 23, 42, 0.6);
        border-radius: 999px;
        white-space: nowrap;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 18px;
        padding: 14px 14px 12px;
        box-shadow: var(--shadow-soft);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 650;
        margin-bottom: 2px;
      }

      .card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.35;
      }

      .status-badge {
        font-size: 11px;
        border-radius: 999px;
        padding: 7px 10px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text-muted);
      }

      .status-badge.active {
        border-color: rgba(34, 197, 94, 0.45);
        color: rgba(34, 197, 94, 0.95);
      }

      .status-badge.inactive {
        border-color: rgba(239, 68, 68, 0.45);
        color: rgba(239, 68, 68, 0.95);
      }

      .btn {
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.75);
        color: var(--text-main);
        border-radius: 12px;
        padding: 9px 12px;
        cursor: pointer;
        font-size: 12px;
        transition: transform 0.05s ease;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn-primary {
        border-color: rgba(99, 102, 241, 0.65);
        background: rgba(99, 102, 241, 0.18);
      }

      .btn-secondary {
        border-color: rgba(148, 163, 184, 0.45);
      }

      .btn-ghost {
        background: transparent;
        border-color: rgba(148, 163, 184, 0.28);
        color: var(--text-muted);
      }

      .btn-small {
        padding: 7px 10px;
        font-size: 11px;
        border-radius: 10px;
      }

      pre {
        margin: 0;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 14px;
        padding: 10px;
        font-size: 12px;
        color: var(--text-main);
        overflow-x: auto;
      }

      textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        padding: 10px;
        font-size: 12px;
        resize: vertical;
        min-height: 120px;
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.6);
      }

      hr {
        border: none;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        margin: 14px 0;
      }

      .section-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.16em;
        margin-bottom: 6px;
      }

      /* Date range controls */
      .date-range {
        margin-top: 6px;
        margin-bottom: 8px;
      }

      .date-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .date-group {
        display: flex;
        flex-direction: column;
        gap: 3px;
        font-size: 11px;
      }

      .date-group label {
        color: var(--text-muted);
      }

      .date-group input[type="date"] {
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        font-size: 12px;
        padding: 6px 8px;
        min-width: 170px;
      }

      .date-group input[type="date"]:focus {
        outline: none;
        border-color: var(--accent);
      }

      .date-helper {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
        line-height: 1.35;
      }

      #entries-list,
      #history-list {
        list-style: none;
        padding-left: 0;
        margin-top: 10px;
        margin-bottom: 0;
      }

      #entries-list li,
      #history-list li {
        font-size: 12px;
        margin-bottom: 6px;
        display: flex;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
      }

      #entries-controls {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 6px;
      }

      #review-output {
        margin-top: 14px;
        max-height: 420px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      .pill-inline {
        font-size: 11px;
        color: var(--text-muted);
        padding: 8px 10px;
        border: 1px solid rgba(148, 163, 184, 0.22);
        background: rgba(15, 23, 42, 0.5);
        border-radius: 999px;
      }

      /* Overlays (extension + GitHub help) */
      .howto-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.92);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
        padding: 16px;
      }

      .howto-card {
        max-width: 560px;
        width: 100%;
        background: radial-gradient(circle at top left, #020617, #020617 24%, #020617 100%);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: var(--shadow-soft);
        padding: 18px 18px 16px;
      }

      .howto-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .howto-title {
        font-size: 15px;
        font-weight: 650;
      }

      .howto-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .howto-close {
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 18px;
        cursor: pointer;
      }

      .step-list {
        list-style: none;
        padding-left: 0;
        margin: 10px 0 0;
      }

      .step-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: flex-start;
      }

      .step-badge {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.12);
        border: 1px solid rgba(129, 140, 248, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #c7d2fe;
        flex-shrink: 0;
      }

      .step-body {
        font-size: 12px;
        color: var(--text-main);
        line-height: 1.35;
      }

      .step-body strong {
        color: #e5e7eb;
      }

      .howto-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 6px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .history-meta {
        flex: 1 1 auto;
      }

      .history-meta strong {
        font-weight: 650;
      }

      .history-meta span {
        color: var(--text-muted);
      }

      /* GitHub import */
      #github-import-section {
        margin-top: 14px;
        padding-top: 10px;
        border-top: 1px dashed rgba(148, 163, 184, 0.3);
      }

      #github-token-input {
        width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        font-size: 12px;
        padding: 6px 8px;
        margin-top: 4px;
      }

      #github-token-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      #github-import-status {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 6px;
      }

      .info-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 11px;
        margin-left: 6px;
        cursor: pointer;
        color: var(--text-muted);
        background: rgba(15, 23, 42, 0.9);
      }

      .info-icon:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
    </style>
  </head>

  <body>
    <div class="app">
      <header class="app-header">
        <div class="brand">
          <img src="rapid-rocket-logo.png" alt="RapidReviewer logo" class="brand-logo" />
          <div>
            <div class="brand-text-main">RapidReviewer.io</div>
            <div class="brand-text-sub">Your GitHub → performance review bridge</div>
          </div>
        </div>
        <div class="app-pill">Logged in via Cognito · Secure by design</div>
      </header>

      <div class="grid">
        <!-- Left column -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Account & subscription</div>
              <div class="card-subtitle">Manage billing, API keys and see your captured PR entries.</div>
            </div>
            <span id="subscription-badge" class="status-badge inactive">Checking…</span>
          </div>

          <div id="status" style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;"></div>

          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
            <button id="subscribe-btn" class="btn btn-primary" style="display:none;">
              Start £0.99/month subscription
            </button>
            <button id="create-api-key-btn" class="btn btn-secondary" style="display:none;">
              Generate / Show API Key
            </button>
            <button id="revoke-api-key-btn" class="btn btn-ghost btn-small" style="display:none;">
              Revoke API Key
            </button>
            <button id="howto-extension-btn" class="btn btn-ghost btn-small" style="display:none;">
              How to connect the Chrome extension
            </button>
          </div>

          <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">
            Use your API key in the Chrome extension to log PR activity from GitHub.
          </div>

          <div class="section-label">API key</div>
          <pre id="api-key-display">—</pre>

          <hr />

          <div id="entries-section" style="display: none;">
            <div class="card-header" style="margin-bottom: 8px; padding: 0;">
              <div>
                <div class="card-title" style="font-size: 14px;">Your PR entries</div>
                <div class="card-subtitle">Captured each time you merge or approve a PR.</div>
              </div>
            </div>

            <div class="date-range">
              <div class="section-label">Date range</div>
              <div class="date-row">
                <div class="date-group">
                  <label for="review-start-date">From</label>
                  <input type="date" id="review-start-date" />
                </div>
                <div class="date-group">
                  <label for="review-end-date">To</label>
                  <input type="date" id="review-end-date" />
                </div>
              </div>
              <div class="date-helper">
                <div><strong>Fix:</strong> If you set only one date, we’ll auto-fill the other and use the range.</div>
                <div>If both are blank, we use the current calendar year.</div>
              </div>
            </div>

            <div style="display:flex; justify-content: space-between; align-items:center; margin-top:6px;">
              <button id="show-entries-btn" class="btn btn-secondary btn-small">
                Load entries (20 per page)
              </button>
              <div id="entries-controls" style="display:none;">
                <button id="next-page-btn" class="btn btn-ghost btn-small">Next 20</button>
              </div>
            </div>

            <ul id="entries-list"></ul>

            <!-- GitHub import section -->
            <div id="github-import-section">
              <div class="card-header" style="padding: 0; margin-bottom: 6px;">
                <div>
                  <div class="card-title" style="font-size: 14px;">
                    GitHub import (beta)
                    <button id="github-howto-btn" class="info-icon" title="How to get a GitHub token">i</button>
                  </div>
                  <div class="card-subtitle">
                    Pull PRs from GitHub into RapidReviewer using the same date range above.
                  </div>
                </div>
              </div>
              <div class="date-helper">
                We’ll fetch PRs authored by you between the selected dates.
                If the range is empty, we default to the current year.
              </div>
              <div style="margin-top: 6px;">
                <div class="section-label" style="margin-bottom: 4px;">GitHub token (optional)</div>
                <input
                  id="github-token-input"
                  type="password"
                  placeholder="ghp_… (if your import Lambda expects a token in the body)"
                />
              </div>
              <div style="display:flex; justify-content:flex-start; gap:8px; margin-top:8px;">
                <button id="github-import-btn" class="btn btn-primary btn-small">
                  Import PRs from GitHub
                </button>
              </div>
              <div id="github-import-status"></div>
            </div>
          </div>
        </section>

        <!-- Right column -->
        <section id="review-section" class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Performance review generator</div>
              <div class="card-subtitle">
                Step 1: Paste your levels &amp; expectations. Step 2: Generate an AI-powered review from your PRs.
              </div>
            </div>
          </div>

          <p id="review-spec-status" style="font-size:12px; color:var(--text-muted); margin-top:0;"></p>

          <button
            id="edit-spec-btn"
            class="btn btn-ghost btn-small"
            style="display:none; margin-bottom:8px;"
          >
            Upload / replace specification
          </button>

          <div id="spec-upload-container" style="display: none; margin-top: 8px;">
            <p style="font-size: 13px; color: var(--text-muted); margin-top:0;">
              Paste your company’s levels &amp; expectations / performance rubric below.
              This box is fully editable — we’ll store it privately and use it to guide your review.
            </p>

            <textarea
              id="spec-text"
              rows="8"
              placeholder="Example:
L3 Engineer:
- Delivers scoped features independently.
- Writes well-tested, maintainable code...

L4 Engineer:
- Owns end-to-end delivery of complex projects...
(etc.)"
            ></textarea>

            <button id="save-spec-btn" class="btn btn-primary" style="margin-top: 8px;">
              Save specification
            </button>
          </div>

          <div class="date-range" style="margin-top: 12px;">
            <div class="section-label">Review period</div>
            <div class="date-helper">
              We use the <strong>same date range</strong> as the entries filter on the left.
              If empty, we use the current calendar year.
            </div>
          </div>

          <div id="review-actions" style="display: none; margin-top: 8px;">
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;">
              <button id="generate-review-btn" class="btn btn-primary">Generate performance review</button>
              <button id="regenerate-review-btn" class="btn btn-ghost btn-small">
                Regenerate with latest entries
              </button>
              <button id="load-history-btn" class="btn btn-ghost btn-small">
                Load historic reviews (this year)
              </button>
            </div>
            <div class="pill-inline">
              Tip: you’re limited to a few generations per month. Update your spec anytime and regenerate.
            </div>
          </div>

          <pre id="review-output">
Your AI-generated performance review will appear here after you click "Generate performance review".
          </pre>

          <ul id="history-list"></ul>
        </section>
      </div>

      <!-- How-to overlay: Chrome extension -->
      <div id="howto-overlay" class="howto-overlay">
        <div class="howto-card">
          <div class="howto-header">
            <div>
              <div class="howto-title">Connect the Chrome extension</div>
              <div class="howto-subtitle">Get your PR activity into RapidReviewer automatically.</div>
            </div>
            <button id="howto-close" class="howto-close" aria-label="Close">×</button>
          </div>

          <ul class="step-list">
            <li class="step-item">
              <div class="step-badge">1</div>
              <div class="step-body"><strong>Install</strong> the extension.</div>
            </li>
            <li class="step-item">
              <div class="step-badge">2</div>
              <div class="step-body">
                <strong>Paste your API key</strong> from the left panel into the extension settings.
              </div>
            </li>
            <li class="step-item">
              <div class="step-badge">3</div>
              <div class="step-body">
                <strong>Use GitHub normally</strong> — merges and approvals will be captured automatically.
              </div>
            </li>
          </ul>

          <div class="howto-footer">
            <div>Need help? Reply to the welcome email.</div>
            <div>RapidReviewer</div>
          </div>
        </div>
      </div>

      <!-- How-to overlay: GitHub token -->
      <div id="github-howto-overlay" class="howto-overlay">
        <div class="howto-card">
          <div class="howto-header">
            <div>
              <div class="howto-title">How to get a GitHub token</div>
              <div class="howto-subtitle">
                Use this token so RapidReviewer can import your PRs.
              </div>
            </div>
            <button id="github-howto-close" class="howto-close" aria-label="Close">×</button>
          </div>

          <ul class="step-list">
            <li class="step-item">
              <div class="step-badge">1</div>
              <div class="step-body">
                In GitHub, click your avatar → <strong>Settings</strong> → <strong>Developer settings</strong>.
              </div>
            </li>
            <li class="step-item">
              <div class="step-badge">2</div>
              <div class="step-body">
                Go to <strong>Personal access tokens</strong> → <strong>Fine-grained tokens</strong> (or classic).
              </div>
            </li>
            <li class="step-item">
              <div class="step-badge">3</div>
              <div class="step-body">
                <strong>Create a new token</strong> with access to the repos you want to import from.
                You only need read access to PRs.
              </div>
            </li>
            <li class="step-item">
              <div class="step-badge">4</div>
              <div class="step-body">
                Copy the token (looks like <code>ghp_…</code>) and paste it into the
                <strong>GitHub token</strong> field on the left, then click
                <strong>Import PRs from GitHub</strong>.
              </div>
            </li>
          </ul>

          <div class="howto-footer">
            <div>Keep your token secret. You can always revoke it from GitHub settings.</div>
            <div>RapidReviewer</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // -----------------------------
      // CONFIG
      // -----------------------------
      const apiBase = "https://api.rapidreviewer.io";
      // Your existing Lambda is behind POST /billing and returns { checkout_url: "..." }
      const stripeCheckoutPath = "/billing";

      // -----------------------------
      // DOM refs
      // -----------------------------
      const subscriptionBadge = document.getElementById("subscription-badge");
      const statusEl = document.getElementById("status");

      const subscribeBtn = document.getElementById("subscribe-btn");
      const createApiKeyBtn = document.getElementById("create-api-key-btn");
      const revokeApiKeyBtn = document.getElementById("revoke-api-key-btn");
      const howtoBtn = document.getElementById("howto-extension-btn");

      const apiKeyDisplay = document.getElementById("api-key-display");
      const entriesSection = document.getElementById("entries-section");
      const startDateInput = document.getElementById("review-start-date");
      const endDateInput = document.getElementById("review-end-date");
      const showEntriesBtn = document.getElementById("show-entries-btn");
      const nextPageBtn = document.getElementById("next-page-btn");
      const entriesControls = document.getElementById("entries-controls");
      const entriesList = document.getElementById("entries-list");

      const githubTokenInput = document.getElementById("github-token-input");
      const githubImportBtn = document.getElementById("github-import-btn");
      const githubImportStatus = document.getElementById("github-import-status");
      const githubHowtoBtn = document.getElementById("github-howto-btn");

      const reviewSpecStatus = document.getElementById("review-spec-status");
      const editSpecBtn = document.getElementById("edit-spec-btn");
      const specUploadContainer = document.getElementById("spec-upload-container");
      const specText = document.getElementById("spec-text");
      const saveSpecBtn = document.getElementById("save-spec-btn");

      const reviewActions = document.getElementById("review-actions");
      const generateReviewBtn = document.getElementById("generate-review-btn");
      const regenerateReviewBtn = document.getElementById("regenerate-review-btn");
      const loadHistoryBtn = document.getElementById("load-history-btn");
      const reviewOutput = document.getElementById("review-output");
      const historyList = document.getElementById("history-list");

      const howtoOverlay = document.getElementById("howto-overlay");
      const howtoClose = document.getElementById("howto-close");

      const githubHowtoOverlay = document.getElementById("github-howto-overlay");
      const githubHowtoClose = document.getElementById("github-howto-close");

      // -----------------------------
      // Auth token + hash handling
      // -----------------------------
      function parseHashParams() {
        const hash = window.location.hash || "";
        const out = {};
        if (!hash.startsWith("#")) return out;
        const qs = hash.slice(1);
        for (const part of qs.split("&")) {
          const [k, v] = part.split("=");
          if (k) out[decodeURIComponent(k)] = decodeURIComponent(v || "");
        }
        return out;
      }

      // Persist id_token (if Cognito redirect) and return hash params (for billing)
      function persistTokenFromUrl() {
        const hashParams = parseHashParams();
        if (hashParams.id_token) {
          window.localStorage.setItem("idToken", hashParams.id_token);
          history.replaceState(null, "", window.location.pathname + window.location.search);
        }
        return hashParams;
      }

      // -----------------------------
      // Date helpers
      // -----------------------------
      function todayISO() {
        return new Date().toISOString().split("T")[0];
      }

      function getNormalizedDateRange(startInput, endInput) {
        let start = (startInput.value || "").trim();
        let end = (endInput.value || "").trim();

        if (start && !end) {
          end = todayISO();
          endInput.value = end;
        } else if (end && !start) {
          const y = new Date(end).getFullYear();
          start = `${y}-01-01`;
          startInput.value = start;
        }

        if (start && end && start > end) {
          const tmp = start;
          start = end;
          end = tmp;
          startInput.value = start;
          endInput.value = end;
        }

        const year =
          (start && new Date(start).getFullYear()) ||
          (end && new Date(end).getFullYear()) ||
          new Date().getFullYear();

        return { start: start || null, end: end || null, year };
      }

      // -----------------------------
      // API helpers
      // -----------------------------
      async function apiFetch(path, { method = "GET", token, body } = {}) {
        const headers = {};
        if (token) headers["Authorization"] = `Bearer ${token}`;
        if (body) headers["Content-Type"] = "application/json";

        const res = await fetch(`${apiBase}${path}`, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined,
        });

        const data = await res.json().catch(() => ({}));
        return { res, data };
      }

      // -----------------------------
      // UI helpers
      // -----------------------------
      function setStatus(msg, isError = false) {
        statusEl.textContent = msg || "";
        statusEl.style.color = isError ? "rgba(239,68,68,0.95)" : "var(--text-muted)";
      }

      function computeMonthAndDate(item) {
        const ts = item.event_ts || item.date || "";
        const d = ts ? new Date(ts) : new Date();
        const monthKey = d.toLocaleString(undefined, { month: "long", year: "numeric" });
        const displayDate = d.toLocaleDateString(undefined, {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
        return { monthKey, displayDate };
      }

      function renderReview(data) {
        const label = data.period_label || "";
        const cached = data.cached ? " (cached)" : "";
        reviewOutput.textContent = `${label}${cached}\n\n${data.review_text || ""}`;
      }

      // -----------------------------
      // Stripe checkout redirect
      // -----------------------------
      async function redirectToStripeCheckout(reason) {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          setStatus("No token found. Please sign in again.", true);
          return;
        }

        setStatus("Redirecting you to Stripe checkout…", false);

        const { res, data } = await apiFetch(stripeCheckoutPath, {
          method: "POST",
          token,
          body: { reason: reason || "subscription_required" },
        });

        if (!res.ok || !data || !data.checkout_url) {
          setStatus(
            "Error starting checkout. Please click “Start £0.99/month subscription” again or contact support.",
            true
          );
          return;
        }

        window.location.href = data.checkout_url;
      }

      // -----------------------------
      // API key helpers (POST /apikey)
      // -----------------------------
      async function loadApiKey(options = {}) {
        const { autoRedirectIfInactive } = options;
        const token = window.localStorage.getItem("idToken");
        if (!token) return;

        // Start in a neutral state
        subscribeBtn.style.display = "none";
        createApiKeyBtn.style.display = "none";
        revokeApiKeyBtn.style.display = "none";
        howtoBtn.style.display = "inline-block";

        apiKeyDisplay.textContent = "Loading…";

        const { res, data } = await apiFetch("/apikey", {
          method: "POST",
          token,
          body: { action: "get_or_create" },
        });

        if (res.status === 402) {
          // subscription_not_active
          subscriptionBadge.textContent = "Subscription inactive";
          subscriptionBadge.classList.remove("active");
          subscriptionBadge.classList.add("inactive");

          apiKeyDisplay.textContent =
            "Subscription not active. We’ll take you to Stripe to start your £0.99/month plan.";
          subscribeBtn.style.display = "inline-block";
          createApiKeyBtn.style.display = "none";
          revokeApiKeyBtn.style.display = "none";

          setStatus("Subscription not active. Redirecting you to Stripe…", true);

          if (autoRedirectIfInactive) {
            await redirectToStripeCheckout("subscription_required");
          } else {
            setStatus(
              "Subscription not active. Click “Start £0.99/month subscription” to open Stripe checkout.",
              true
            );
          }
          return;
        }

        if (res.status === 404) {
          // user_not_found
          subscriptionBadge.textContent = "No account";
          subscriptionBadge.classList.remove("active");
          subscriptionBadge.classList.add("inactive");

          apiKeyDisplay.textContent =
            "We couldn't find your user record. Please sign up again or contact support.";
          subscribeBtn.style.display = "none";
          createApiKeyBtn.style.display = "none";
          revokeApiKeyBtn.style.display = "none";

          setStatus("No user found for this login. Try signing up again.", true);
          return;
        }

        if (!res.ok) {
          subscriptionBadge.textContent = "Error";
          subscriptionBadge.classList.remove("active");
          subscriptionBadge.classList.add("inactive");

          apiKeyDisplay.textContent = "Error loading API key.";
          subscribeBtn.style.display = "none";
          createApiKeyBtn.style.display = "none";
          revokeApiKeyBtn.style.display = "none";

          setStatus("Error loading API key: " + (data.error || res.status), true);
          return;
        }

        // At this point subscription is active
        subscriptionBadge.textContent = "Active";
        subscriptionBadge.classList.remove("inactive");
        subscriptionBadge.classList.add("active");

        const key = data.api_key || data.key || "";
        subscribeBtn.style.display = "none";
        createApiKeyBtn.style.display = "inline-block";
        revokeApiKeyBtn.style.display = "inline-block";

        if (key) {
          apiKeyDisplay.textContent = key;
        } else {
          apiKeyDisplay.textContent = "No API key yet. Click “Generate / Show API Key”.";
        }

        setStatus("Subscription active. You’re good to go.");
      }

      async function createOrShowApiKey() {
        await loadApiKey({ autoRedirectIfInactive: false });
      }

      async function revokeApiKeyHandler() {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          alert("No token found, please sign in again.");
          return;
        }

        if (
          !window.confirm(
            "Revoke your API key? Your extension will stop working until you generate a new one."
          )
        ) {
          return;
        }

        const { res, data } = await apiFetch("/apikey", {
          method: "POST",
          token,
          body: { action: "revoke" },
        });

        if (!res.ok) {
          alert("Error revoking API key: " + (data.error || res.status));
          return;
        }

        // Subscription is still active, you've just revoked the key
        subscriptionBadge.textContent = "Active";
        subscriptionBadge.classList.remove("inactive");
        subscriptionBadge.classList.add("active");

        apiKeyDisplay.textContent =
          "API key revoked. Click “Generate / Show API Key” to create a new one.";
        createApiKeyBtn.style.display = "inline-block";
        revokeApiKeyBtn.style.display = "none";

        setStatus("API key revoked. Generate a new one if needed.");
      }

      // -----------------------------
      // Entries pagination + edit/delete
      // -----------------------------
      let entriesNextCursor = null;
      let lastRenderedMonthKey = null;

      async function updateEntry(dateValue, newSummary) {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          alert("No token found, please sign in again.");
          return;
        }

        const { res, data } = await apiFetch("/entries/update", {
          method: "POST",
          token,
          body: { date: dateValue, summary: newSummary },
        });

        if (!res.ok) {
          alert("Error updating entry: " + (data.error || res.status));
          return;
        }

        await loadEntriesPage(token, false);
      }

      async function deleteEntry(dateValue) {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          alert("No token found, please sign in again.");
          return;
        }

        const { res, data } = await apiFetch("/entries/update", {
          method: "POST",
          token,
          body: { date: dateValue, delete: true },
        });

        if (!res.ok) {
          alert("Error deleting entry: " + (data.error || res.status));
          return;
        }

        await loadEntriesPage(token, false);
      }

      async function loadEntriesPage(token, isNext) {
        const { start, end, year } = getNormalizedDateRange(startDateInput, endDateInput);

        const url = new URL(`${apiBase}/entries`);
        if (start && end) {
          url.searchParams.set("start_date", start);
          url.searchParams.set("end_date", end);
        } else {
          url.searchParams.set("year", String(year));
        }
        url.searchParams.set("limit", "20");
        if (isNext && entriesNextCursor) {
          url.searchParams.set("cursor", entriesNextCursor);
        }

        const res = await fetch(url.toString(), {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await res.json().catch(() => ({}));
        console.log("/entries response:", data);

        if (!res.ok) {
          alert("Error loading entries: " + (data.error || res.status));
          return;
        }

        const items = data.items || [];
        entriesNextCursor = data.next_cursor || data.nextCursor || null;

        if (!isNext) {
          entriesList.innerHTML = "";
          lastRenderedMonthKey = null;
        }

        items.forEach((item) => {
          const { monthKey, displayDate } = computeMonthAndDate(item);

          if (monthKey !== lastRenderedMonthKey) {
            const headerLi = document.createElement("li");
            headerLi.textContent = monthKey;
            headerLi.style.fontWeight = "700";
            headerLi.style.marginTop = lastRenderedMonthKey ? "16px" : "0";
            headerLi.style.marginBottom = "4px";
            entriesList.appendChild(headerLi);
            lastRenderedMonthKey = monthKey;
          }

          const repoName = item.repo_name || item.repo || "";
          const pr = item.pr_number || "";
          const summary = item.summary || "";
          const prUrl = item.pr_url || item.url || "#";
          const dateKey = item.date || item.event_ts;

          const li = document.createElement("li");
          li.style.display = "flex";
          li.style.alignItems = "center";
          li.style.marginBottom = "6px";
          li.style.gap = "8px";

          const link = document.createElement("a");
          link.style.flex = "1 1 auto";
          link.href = prUrl && prUrl !== "#" ? prUrl : "#";
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = `[${displayDate}] ${repoName} #${pr} – ${summary}`;

          if (!prUrl || prUrl === "#") {
            link.style.pointerEvents = "none";
            link.style.textDecoration = "none";
            link.style.color = "inherit";
          }

          const actions = document.createElement("div");
          actions.style.display = "flex";
          actions.style.gap = "4px";
          actions.style.flexShrink = "0";

          if (dateKey) {
            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-ghost btn-small";
            editBtn.textContent = "Edit";
            editBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              e.stopPropagation();
              const current = summary || "";
              const next = window.prompt("Edit summary for this entry:", current);
              if (next == null) return;
              const trimmed = next.trim();
              if (!trimmed) {
                alert("Summary cannot be empty.");
                return;
              }
              await updateEntry(dateKey, trimmed);
            });

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn btn-ghost btn-small";
            deleteBtn.textContent = "Delete";
            deleteBtn.style.color = "rgba(248,113,113,0.9)";
            deleteBtn.addEventListener("click", async (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (!window.confirm("Delete this entry? This cannot be undone.")) return;
              await deleteEntry(dateKey);
            });

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
          }

          li.appendChild(link);
          li.appendChild(actions);
          entriesList.appendChild(li);
        });

        entriesControls.style.display = entriesNextCursor ? "flex" : "none";
      }

      // -----------------------------
      // GitHub import
      // -----------------------------
      async function importFromGitHub() {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          alert("No token found, please sign in again.");
          return;
        }

        const { start, end, year } = getNormalizedDateRange(startDateInput, endDateInput);
        const body = { year };

        if (start && end) {
          body.start_date = start;
          body.end_date = end;
        }

        const ghToken = (githubTokenInput.value || "").trim();
        if (ghToken) {
          body.github_token = ghToken;
        }

        githubImportStatus.style.color = "var(--text-muted)";
        githubImportStatus.textContent = "Importing PRs from GitHub…";

        const { res, data } = await apiFetch("/github-import", {
          method: "POST",
          token,
          body,
        });

        console.log("/github-import response:", data);

        if (!res.ok) {
          githubImportStatus.style.color = "rgba(239,68,68,0.95)";
          githubImportStatus.textContent =
            "Error importing PRs: " + (data.error || data.message || res.status);
          return;
        }

        const imported =
          data.imported_count ??
          data.imported ??
          data.count ??
          data.total_imported ??
          0;

        githubImportStatus.style.color = "var(--text-muted)";
        githubImportStatus.textContent = `Imported ${imported} PR${imported === 1 ? "" : "s"} from GitHub.`;

        await loadEntriesPage(token, false);
      }

      // -----------------------------
      // Review generation
      // -----------------------------
      async function generateOrRegenReview({ forceRegen }) {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          alert("No token found, please sign in again.");
          return;
        }

        const { start, end, year } = getNormalizedDateRange(startDateInput, endDateInput);

        const body = { year, force_regen: !!forceRegen };
        if (start && end) {
          body.start_date = start;
          body.end_date = end;
        }

        reviewOutput.textContent = "Generating…";

        const { res, data } = await apiFetch("/performance-review", {
          method: "POST",
          token,
          body,
        });

        console.log("/performance-review response:", data);

        if (!res.ok) {
          if (res.status === 429 && data.error === "monthly_limit_reached") {
            reviewOutput.textContent =
              `You've reached your monthly limit of ${data.limit} reviews.\n` +
              `Used: ${data.used}. Try again next month.`;
          } else {
            reviewOutput.textContent =
              "Error generating review: " + (data.error || res.status) +
              (data.message ? "\n\n" + data.message : "");
          }
          return;
        }

        renderReview(data);
      }

      // -----------------------------
      // History
      // -----------------------------
      async function loadHistory() {
        const token = window.localStorage.getItem("idToken");
        if (!token) {
          alert("No token found, please sign in again.");
          return;
        }

        const { start, end, year } = getNormalizedDateRange(startDateInput, endDateInput);

        const url = new URL(`${apiBase}/performance-review`);
        url.searchParams.set("year", String(year));

        const res = await fetch(url.toString(), {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        });

        const data = await res.json().catch(() => ({}));
        console.log("/performance-review history response:", data);

        if (!res.ok) {
          alert("Error loading historic reviews: " + (data.error || res.status));
          return;
        }

        const items = data.items || [];
        historyList.innerHTML = "";

        if (!items.length) {
          const li = document.createElement("li");
          li.textContent = "No historic reviews for this year yet.";
          historyList.appendChild(li);
          return;
        }

        items.forEach((item, idx) => {
          const li = document.createElement("li");

          const meta = document.createElement("div");
          meta.className = "history-meta";

          const title = document.createElement("div");
          const genAt = item.generated_at || "";
          const label = item.period_label || String(year);
          title.innerHTML = `<strong>Review ${idx + 1}</strong> · <span>${label}</span>`;
          meta.appendChild(title);

          if (genAt) {
            const ts = document.createElement("div");
            ts.style.fontSize = "10px";
            ts.style.color = "var(--text-muted)";
            ts.textContent = `Generated at: ${genAt}`;
            meta.appendChild(ts);
          }

          const btn = document.createElement("button");
          btn.className = "btn btn-ghost btn-small";
          btn.textContent = "Download";
          btn.addEventListener("click", () => {
            const text = item.review_text || "";
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            const safeLabel = (label || String(year)).replace(/[^a-zA-Z0-9_-]+/g, "-");
            a.download = `rapidreviewer-${safeLabel}-${idx + 1}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });

          li.appendChild(meta);
          li.appendChild(btn);
          historyList.appendChild(li);
        });
      }

      // -----------------------------
      // Minimal bootstrap
      // -----------------------------
      function showAuthedUI() {
        entriesSection.style.display = "block";
        reviewActions.style.display = "block";

        // Don't assume subscription state yet
        subscribeBtn.style.display = "none";
        createApiKeyBtn.style.display = "none";
        revokeApiKeyBtn.style.display = "none";
        howtoBtn.style.display = "inline-block";
        editSpecBtn.style.display = "inline-block";

        subscriptionBadge.textContent = "Checking…";
        subscriptionBadge.classList.remove("active");
        subscriptionBadge.classList.add("inactive");

        setStatus("Welcome! Checking your subscription status…");
      }

      // -----------------------------
      // Event listeners
      // -----------------------------
      showEntriesBtn.addEventListener("click", async () => {
        const token = window.localStorage.getItem("idToken");
        if (!token) return alert("No token found, please sign in again.");
        entriesNextCursor = null;
        await loadEntriesPage(token, false);
      });

      nextPageBtn.addEventListener("click", async () => {
        const token = window.localStorage.getItem("idToken");
        if (!token) return alert("No token found, please sign in again.");
        await loadEntriesPage(token, true);
      });

      githubImportBtn.addEventListener("click", async () => {
        await importFromGitHub();
      });

      generateReviewBtn.addEventListener("click", async () => {
        await generateOrRegenReview({ forceRegen: false });
      });

      regenerateReviewBtn.addEventListener("click", async () => {
        await generateOrRegenReview({ forceRegen: true });
      });

      loadHistoryBtn.addEventListener("click", async () => {
        await loadHistory();
      });

      editSpecBtn.addEventListener("click", () => {
        const isOpen = specUploadContainer.style.display !== "none";
        specUploadContainer.style.display = isOpen ? "none" : "block";
      });

      saveSpecBtn.addEventListener("click", async () => {
        const token = window.localStorage.getItem("idToken");
        if (!token) return alert("No token found, please sign in again.");

        const text = (specText.value || "").trim();
        if (!text) return alert("Please paste your specification first.");

        const { res, data } = await apiFetch("/review-spec", {
          method: "POST",
          token,
          body: { review_spec: text },
        });

        console.log("/review-spec response:", data);

        if (!res.ok) {
          alert("Error saving spec: " + (data.error || res.status));
          return;
        }

        reviewSpecStatus.textContent = "✅ Spec saved. You can now generate reviews.";
        specUploadContainer.style.display = "none";
      });

      createApiKeyBtn.addEventListener("click", async () => {
        await createOrShowApiKey();
      });

      revokeApiKeyBtn.addEventListener("click", async () => {
        await revokeApiKeyHandler();
      });

      subscribeBtn.addEventListener("click", async () => {
        await redirectToStripeCheckout("subscription_required");
      });

      howtoBtn.addEventListener("click", () => {
        howtoOverlay.style.display = "flex";
      });

      howtoClose.addEventListener("click", () => {
        howtoOverlay.style.display = "none";
      });

      howtoOverlay.addEventListener("click", (e) => {
        if (e.target === howtoOverlay) howtoOverlay.style.display = "none";
      });

      githubHowtoBtn.addEventListener("click", () => {
        githubHowtoOverlay.style.display = "flex";
      });

      githubHowtoClose.addEventListener("click", () => {
        githubHowtoOverlay.style.display = "none";
      });

      githubHowtoOverlay.addEventListener("click", (e) => {
        if (e.target === githubHowtoOverlay) githubHowtoOverlay.style.display = "none";
      });

      // -----------------------------
      // Init
      // -----------------------------
      const hashParams = persistTokenFromUrl();
      const billingStatus = hashParams.billing || null;

      const token = window.localStorage.getItem("idToken");
      if (!token) {
        setStatus("No token found. Please sign in again.", true);
        subscriptionBadge.textContent = "Not signed in";
        subscriptionBadge.classList.remove("active");
        subscriptionBadge.classList.add("inactive");
      } else {
        showAuthedUI();

        if (billingStatus === "success") {
          setStatus("Payment successful. Finalising your subscription…");
          loadApiKey({ autoRedirectIfInactive: false });
        } else if (billingStatus === "cancel") {
          setStatus(
            "You cancelled checkout. Click “Start £0.99/month subscription” to try again.",
            true
          );
          loadApiKey({ autoRedirectIfInactive: false });
        } else {
          // Normal case: first login or returning user
          loadApiKey({ autoRedirectIfInactive: true });
        }
      }
    </script>
  </body>
</html>
