<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Your Account</title>
  </head>
  <body>
    <h1>Your PR Logger Account</h1>
    <div id="status"></div>
    <button id="create-api-key-btn" style="display:none;">Generate API Key</button>
    <pre id="api-key-display"></pre>

    <script>
      const apiBase = "https://api.yourdomain.com"; // API Gateway URL

      function parseHash() {
        const h = window.location.hash.substring(1);
        const params = new URLSearchParams(h);
        return {
          idToken: params.get("id_token"),
          accessToken: params.get("access_token")
        };
      }

      const { idToken } = parseHash();
      if (!idToken) {
        document.getElementById("status").textContent =
          "No token found. Please sign in again.";
      } else {
        // store for later use
        window.localStorage.setItem("idToken", idToken);

        // call backend to init user + check subscription
        initUser(idToken);
      }

      async function initUser(token) {
        document.getElementById("status").textContent = "Loading account...";
        const res = await fetch(`${apiBase}/user/init`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({})
        });

        const data = await res.json();
        if (!res.ok) {
          document.getElementById("status").textContent =
            "Error: " + (data.error || res.status);
          return;
        }

        // data: { user_id, subscription_status, has_api_key }
        if (data.subscription_status !== "active") {
          document.getElementById("status").textContent =
            "Subscription inactive. Click here to start your Â£5/mo subscription.";
          // Show a link/button to call /billing/create-checkout-session
          // and redirect to Stripe Checkout
        } else {
          document.getElementById("status").textContent =
            "Subscription active.";
          document.getElementById("create-api-key-btn").style.display = "inline-block";
        }
      }

      document
        .getElementById("create-api-key-btn")
        .addEventListener("click", async () => {
          const token = window.localStorage.getItem("idToken");
          const res = await fetch(`${apiBase}/apikey`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({})
          });
          const data = await res.json();
          if (!res.ok) {
            alert("Error generating API key: " + (data.error || res.status));
            return;
          }
          document.getElementById("api-key-display").textContent =
            "API Key (paste into extension):\n" + data.api_key;
        });
    </script>
  </body>
</html>
