<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>RapidReviewer · Admin Metrics</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --bg: #0b1220;
        --card: rgba(2, 6, 23, 0.85);
        --card-border: rgba(148, 163, 184, 0.25);
        --text-main: #e5e7eb;
        --text-muted: rgba(148, 163, 184, 0.9);
        --accent: rgb(99, 102, 241);
        --shadow-soft: 0 14px 40px rgba(0, 0, 0, 0.45);

        --good: rgba(34, 197, 94, 0.95);
        --warn: rgba(245, 158, 11, 0.95);
        --bad: rgba(239, 68, 68, 0.95);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }

      body {
        margin: 0;
        min-height: 100dvh;
        min-height: 100vh;
        overflow-x: hidden;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text-main);
        background: radial-gradient(circle at top left, #0b1220, #050913 55%, #020617);
      }

      a { color: inherit; }

      .app {
        max-width: 1100px;
        margin: 0 auto;
        padding:
          calc(18px + env(safe-area-inset-top))
          calc(14px + env(safe-area-inset-right))
          calc(28px + env(safe-area-inset-bottom))
          calc(14px + env(safe-area-inset-left));
      }

      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .brand-logo {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        box-shadow: var(--shadow-soft);
      }

      .brand-text-main {
        font-weight: 700;
        font-size: 14px;
        letter-spacing: 0.01em;
      }

      .brand-text-sub {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .app-pill {
        font-size: 12px;
        color: var(--text-muted);
        padding: 8px 10px;
        border: 1px solid var(--card-border);
        background: rgba(15, 23, 42, 0.6);
        border-radius: 999px;
        white-space: nowrap;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 18px;
        padding: 14px 14px 12px;
        box-shadow: var(--shadow-soft);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 650;
        margin-bottom: 2px;
      }

      .card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.35;
      }

      .btn {
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.75);
        color: var(--text-main);
        border-radius: 12px;
        padding: 9px 12px;
        cursor: pointer;
        font-size: 12px;
        transition: transform 0.05s ease;
        user-select: none;
      }
      .btn:active { transform: translateY(1px); }

      .btn-primary {
        border-color: rgba(99, 102, 241, 0.65);
        background: rgba(99, 102, 241, 0.18);
      }

      .btn-ghost {
        background: transparent;
        border-color: rgba(148, 163, 184, 0.28);
        color: var(--text-muted);
      }

      .btn-small {
        padding: 7px 10px;
        font-size: 11px;
        border-radius: 10px;
      }

      .section-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.16em;
        margin-bottom: 6px;
      }

      .input, select {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        padding: 9px 10px;
        font-size: 12px;
        outline: none;
        min-width: 160px;
      }
      .input:focus, select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.6);
      }
      .input::placeholder { color: rgba(148, 163, 184, 0.8); }

      /* ---- Admin layout ---- */
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .toolbar-left {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .toolbar-right {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      @media (max-width: 900px) {
        .admin-grid { grid-template-columns: 1fr; }
        .app-header { flex-direction: column; align-items: flex-start; gap: 8px; }
        .app-pill { width: 100%; white-space: normal; }
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 14px;
        margin-bottom: 14px;
      }
      @media (max-width: 900px) {
        .kpi-grid { grid-template-columns: 1fr 1fr; }
      }
      @media (max-width: 560px) {
        .kpi-grid { grid-template-columns: 1fr; }
      }

      .kpi {
        padding: 14px 14px 12px;
        position: relative;
        overflow: hidden;
      }
      .kpi::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.12), transparent 48%);
        pointer-events: none;
      }
      .kpi-label {
        position: relative;
        font-size: 12px;
        color: var(--text-muted);
        margin: 0 0 8px;
      }
      .kpi-value {
        position: relative;
        font-size: 24px;
        font-weight: 750;
        letter-spacing: 0.01em;
        margin: 0;
      }
      .kpi-sub {
        position: relative;
        margin-top: 10px;
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.35;
      }

      .seg {
        display: inline-flex;
        gap: 6px;
        padding: 4px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.55);
      }
      .seg button {
        border: 1px solid transparent;
        background: transparent;
        color: var(--text-muted);
        padding: 7px 10px;
        border-radius: 999px;
        font-weight: 650;
        font-size: 11px;
        cursor: pointer;
      }
      .seg button.active {
        color: var(--text-main);
        border-color: rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.8);
      }

      /* Charts */
      .chart-wrap {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid rgba(148, 163, 184, 0.18);
      }

      /* Table */
      .table-wrap {
        overflow: auto;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.55);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 860px;
      }

      th, td {
        text-align: left;
        padding: 12px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.16);
        font-size: 12px;
        white-space: nowrap;
      }

      th {
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        background: rgba(15, 23, 42, 0.7);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .status-badge {
        font-size: 11px;
        border-radius: 999px;
        padding: 7px 10px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text-muted);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .status-badge.active { border-color: rgba(34, 197, 94, 0.45); color: rgba(34, 197, 94, 0.95); }
      .status-badge.inactive { border-color: rgba(239, 68, 68, 0.45); color: rgba(239, 68, 68, 0.95); }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.8);
      }
      .dot.good { background: var(--good); }
      .dot.bad { background: var(--bad); }

      .muted { color: var(--text-muted); }

      .error-banner {
        display: none;
        margin-bottom: 12px;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.08);
        color: rgba(239, 68, 68, 0.95);
        font-size: 12px;
        line-height: 1.35;
      }

      .success-banner {
        display: none;
        margin-bottom: 12px;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(34, 197, 94, 0.35);
        background: rgba(34, 197, 94, 0.08);
        color: rgba(34, 197, 94, 0.95);
        font-size: 12px;
        line-height: 1.35;
      }

      @media (max-width: 600px) {
        .app {
          padding:
            calc(16px + env(safe-area-inset-top))
            calc(10px + env(safe-area-inset-right))
            calc(24px + env(safe-area-inset-bottom))
            calc(10px + env(safe-area-inset-left));
        }
        .brand-logo { width: 30px; height: 30px; }
        .brand-text-main { font-size: 13px; }
        .brand-text-sub { font-size: 11px; }
        .card { border-radius: 16px; padding: 12px 10px 10px; }
        .btn { padding: 7px 10px; font-size: 11px; }
        .btn-small { padding: 6px 8px; font-size: 10px; }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <header class="app-header">
        <div class="brand">
          <img src="rapid-rocket-logo.png" alt="RapidReviewer logo" class="brand-logo" />
          <div>
            <div class="brand-text-main">RapidReviewer.io</div>
            <div class="brand-text-sub">Admin metrics · Company dashboard</div>
          </div>
        </div>

        <div class="app-pill" id="header-pill">Checking auth…</div>
      </header>

      <div class="error-banner" id="error-banner"></div>
      <div class="success-banner" id="success-banner"></div>

      <section class="card" style="margin-bottom: 14px;">
        <div class="card-header">
          <div>
            <div class="card-title">Metrics overview</div>
            <div class="card-subtitle">
              “Engineers actively merging PRs” = engineers with ≥1 merged PR in the selected period.
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <a href="./post-auth.html" class="btn btn-ghost btn-small">← Back</a>
            <button id="sign-in-btn" class="btn btn-primary btn-small" style="display:none;">Sign in</button>
            <button id="sign-out-btn" class="btn btn-ghost btn-small" style="display:none;">Sign out</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <label class="section-label" style="margin:0;">Period</label>
            <select id="period-select">
              <option value="7">Last 7 days</option>
              <option value="14" selected>Last 14 days</option>
              <option value="30">Last 30 days</option>
            </select>

            <label class="section-label" style="margin:0 0 0 6px;">Team</label>
            <select id="team-select">
              <option value="all" selected>All teams</option>
            </select>

            <input id="search-input" class="input" placeholder="Search user (name/email)..." />
          </div>

          <div class="toolbar-right">
            <button id="refresh-btn" class="btn btn-ghost">Refresh</button>
            <button id="export-btn" class="btn btn-primary">Export CSV</button>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <div class="kpi-grid" id="kpi-grid">
        <section class="card kpi">
          <div class="kpi-label">Engineers actively merging PRs</div>
          <h3 class="kpi-value" id="kpi-active">—</h3>
          <div class="kpi-sub" id="kpi-active-sub">—</div>
        </section>

        <section class="card kpi">
          <div class="kpi-label">Merged PRs</div>
          <h3 class="kpi-value" id="kpi-merged">—</h3>
          <div class="kpi-sub" id="kpi-merged-sub">—</div>
        </section>

        <section class="card kpi">
          <div class="kpi-label">Engineers (seats provisioned)</div>
          <h3 class="kpi-value" id="kpi-seats">—</h3>
          <div class="kpi-sub" id="kpi-seats-sub">—</div>
        </section>

        <section class="card kpi">
          <div class="kpi-label">Tagged merged PRs</div>
          <h3 class="kpi-value" id="kpi-tagged">—</h3>
          <div class="kpi-sub" id="kpi-tagged-sub">—</div>
        </section>
      </div>

      <!-- Charts -->
      <div class="admin-grid" style="margin-bottom: 14px;">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Activity over time</div>
              <div class="card-subtitle">Merged PRs and daily active engineers.</div>
            </div>
            <span class="app-pill" id="range-pill">—</span>
          </div>

          <div class="chart-wrap">
            <canvas id="activity-chart" height="120"></canvas>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title" id="breakdown-title">Team breakdown</div>
              <div class="card-subtitle" id="breakdown-subtitle">Share of merged PRs.</div>
            </div>

            <div class="seg" aria-label="Breakdown toggle">
              <button id="breakdown-team" class="active" type="button">Team</button>
              <button id="breakdown-type" type="button">Work type</button>
            </div>
          </div>

          <div class="chart-wrap">
            <canvas id="breakdown-chart" height="170"></canvas>
          </div>

          <div class="card-subtitle" id="breakdown-note" style="margin-top:10px;">
            Teams come from your directory mapping (or stored user team field).
          </div>
        </section>
      </div>

      <!-- Users table -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Users</div>
            <div class="card-subtitle">Merged PR activity by engineer for the selected period.</div>
          </div>
          <span class="app-pill" id="users-pill">Showing —</span>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Team</th>
                <th>Merged PRs</th>
                <th>Top work type</th>
                <th>Last activity</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="users-tbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      // -----------------------------
      // CONFIG (matches your existing index.html patterns)
      // -----------------------------
      const apiBase = "https://api.rapidreviewer.io";
      const adminMetricsPath = "/admin/metrics";

      // Your Hosted UI config (optional convenience for sign-in button)
      const cognitoDomain = "auth.rapidreviewer.io";
      const clientId = "3llork2t46v9n0u21n35sgknh4";
      const redirectUri = "https://matthewboyd.github.io/post-auth.html";
      const loginUrl =
        `https://${cognitoDomain}/oauth2/authorize` +
        `?client_id=${encodeURIComponent(clientId)}` +
        `&response_type=token` +
        `&scope=${encodeURIComponent("openid email profile")}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}`;

      // Token key matches your index.html usage
      const TOKEN_KEY = "idToken";

      // -----------------------------
      // DOM refs
      // -----------------------------
      const headerPill = document.getElementById("header-pill");
      const errorBanner = document.getElementById("error-banner");
      const successBanner = document.getElementById("success-banner");

      const signInBtn = document.getElementById("sign-in-btn");
      const signOutBtn = document.getElementById("sign-out-btn");

      const periodSelect = document.getElementById("period-select");
      const teamSelect = document.getElementById("team-select");
      const searchInput = document.getElementById("search-input");
      const refreshBtn = document.getElementById("refresh-btn");
      const exportBtn = document.getElementById("export-btn");

      const rangePill = document.getElementById("range-pill");
      const usersPill = document.getElementById("users-pill");

      const kpiActive = document.getElementById("kpi-active");
      const kpiActiveSub = document.getElementById("kpi-active-sub");
      const kpiMerged = document.getElementById("kpi-merged");
      const kpiMergedSub = document.getElementById("kpi-merged-sub");
      const kpiSeats = document.getElementById("kpi-seats");
      const kpiSeatsSub = document.getElementById("kpi-seats-sub");
      const kpiTagged = document.getElementById("kpi-tagged");
      const kpiTaggedSub = document.getElementById("kpi-tagged-sub");

      const breakdownTitle = document.getElementById("breakdown-title");
      const breakdownSubtitle = document.getElementById("breakdown-subtitle");
      const breakdownNote = document.getElementById("breakdown-note");
      const breakdownTeamBtn = document.getElementById("breakdown-team");
      const breakdownTypeBtn = document.getElementById("breakdown-type");

      const usersTbody = document.getElementById("users-tbody");

      // -----------------------------
      // State
      // -----------------------------
      let state = {
        dataset: null,
        charts: {
          activity: null,
          breakdown: null,
        },
        breakdownMode: "team", // "team" | "type"
      };

      // -----------------------------
      // UI helpers
      // -----------------------------
      function setError(msg) {
        if (!msg) {
          errorBanner.style.display = "none";
          errorBanner.textContent = "";
          return;
        }
        errorBanner.style.display = "block";
        errorBanner.textContent = msg;
      }

      function setSuccess(msg) {
        if (!msg) {
          successBanner.style.display = "none";
          successBanner.textContent = "";
          return;
        }
        successBanner.style.display = "block";
        successBanner.textContent = msg;
        setTimeout(() => setSuccess(""), 1600);
      }

      function fmtPct(n) {
        if (!isFinite(n)) return "0%";
        return `${Math.round(n)}%`;
      }

      function fmtIso(iso) {
        if (!iso) return "—";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString(undefined, {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function statusBadge(status) {
        const isActive = String(status).toLowerCase() === "active";
        const cls = isActive ? "active" : "inactive";
        const dotCls = isActive ? "good" : "bad";
        const label = isActive ? "Active" : "Inactive";
        return `<span class="status-badge ${cls}"><span class="dot ${dotCls}"></span>${label}</span>`;
      }

      // -----------------------------
      // Auth
      // -----------------------------
      function getToken() {
        return window.localStorage.getItem(TOKEN_KEY);
      }

      function signIn() {
        window.location.href = loginUrl;
      }

      function signOut() {
        window.localStorage.removeItem(TOKEN_KEY);
        headerPill.textContent = "Signed out";
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        setError("You are signed out. Please sign in to view admin metrics.");
        clearUI();
      }

      // -----------------------------
      // API
      // -----------------------------
      async function apiFetch(path, { method = "GET", token } = {}) {
        const headers = {};
        if (token) headers["Authorization"] = `Bearer ${token}`;

        const res = await fetch(`${apiBase}${path}`, { method, headers });
        const txt = await res.text();
        let data = {};
        try { data = txt ? JSON.parse(txt) : {}; } catch { data = { raw: txt }; }
        return { res, data };
      }

      async function fetchAdminMetrics({ periodDays, team }) {
        const token = getToken();
        if (!token) throw new Error("missing_token");

        const url = `${adminMetricsPath}?periodDays=${encodeURIComponent(periodDays)}&team=${encodeURIComponent(team)}`;
        const { res, data } = await apiFetch(url, { method: "GET", token });

        if (!res.ok) {
          const msg =
            data?.message ||
            data?.error ||
            (typeof data === "string" ? data : "") ||
            `HTTP ${res.status}`;
          const err = new Error(msg);
          err.status = res.status;
          err.data = data;
          throw err;
        }

        return data;
      }

      // -----------------------------
      // Rendering
      // -----------------------------
      function clearUI() {
        kpiActive.textContent = "—";
        kpiActiveSub.textContent = "—";
        kpiMerged.textContent = "—";
        kpiMergedSub.textContent = "—";
        kpiSeats.textContent = "—";
        kpiSeatsSub.textContent = "—";
        kpiTagged.textContent = "—";
        kpiTaggedSub.textContent = "—";
        rangePill.textContent = "—";
        usersPill.textContent = "Showing —";
        usersTbody.innerHTML = "";

        if (state.charts.activity) state.charts.activity.destroy();
        if (state.charts.breakdown) state.charts.breakdown.destroy();
        state.charts.activity = null;
        state.charts.breakdown = null;
      }

      function setTeamOptions(teams) {
        const current = teamSelect.value || "all";
        const options = [`<option value="all">All teams</option>`]
          .concat((teams || []).map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`));
        teamSelect.innerHTML = options.join("");
        // restore if possible
        const exists = Array.from(teamSelect.options).some(o => o.value === current);
        teamSelect.value = exists ? current : "all";
      }

      function computeKpis(ds) {
        const seats = Number(ds.seats || 0);
        const mergedTotal = (ds.users || []).reduce((a, u) => a + Number(u.mergedPRs || 0), 0);
        const active = (ds.users || []).filter(u => Number(u.mergedPRs || 0) >= 1).length;
        const activePct = seats > 0 ? (active / seats) * 100 : 0;

        const taggedMerged = Number(ds.taggedMergedTotal || 0);
        const taggedPct = mergedTotal > 0 ? (taggedMerged / mergedTotal) * 100 : 0;

        return { seats, mergedTotal, active, activePct, taggedMerged, taggedPct };
      }

      function renderKpis(ds) {
        const { seats, mergedTotal, active, activePct, taggedMerged, taggedPct } = computeKpis(ds);

        kpiActive.textContent = `${active} (${fmtPct(activePct)})`;
        kpiActiveSub.textContent = `Active of ${seats} engineers`;

        kpiMerged.textContent = String(mergedTotal);
        kpiMergedSub.textContent = `Total merged PRs in period`;

        kpiSeats.textContent = String(seats);
        kpiSeatsSub.textContent = `Provisioned engineers in tenant`;

        kpiTagged.textContent = `${taggedMerged} (${fmtPct(taggedPct)})`;
        kpiTaggedSub.textContent = `Merged PR tag coverage`;
      }

      function renderRange(ds) {
        const r = ds.range;
        if (r?.start && r?.end) {
          rangePill.textContent = `${r.start.slice(0,10)} → ${r.end.slice(0,10)}`;
          return;
        }
        // fallback
        const periodDays = Number(ds.periodDays || periodSelect.value || 14);
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - periodDays);
        rangePill.textContent = `${start.toISOString().slice(0,10)} → ${end.toISOString().slice(0,10)}`;
      }

      function renderUsersTable(ds) {
        const q = (searchInput.value || "").trim().toLowerCase();
        let users = (ds.users || []).slice();

        if (q) {
          users = users.filter(u => {
            const s = `${u.name || ""} ${u.email || ""}`.toLowerCase();
            return s.includes(q);
          });
        }

        usersPill.textContent = `Showing ${users.length}`;

        usersTbody.innerHTML = users.map(u => {
          const name = escapeHtml(u.name || u.email || u.id || "—");
          const email = escapeHtml(u.email || "");
          const team = escapeHtml(u.team || "Unknown");
          const merged = Number(u.mergedPRs || 0);
          const topType = escapeHtml(u.topType || "—");
          const last = fmtIso(u.lastActivity);
          const status = merged >= 1 ? "Active" : "Inactive";

          return `
            <tr>
              <td>
                <div style="display:flex; flex-direction:column; gap:3px;">
                  <div style="font-weight:700;">${name}</div>
                  <div class="muted" style="font-size:11px;">${email || "—"}</div>
                </div>
              </td>
              <td>${team}</td>
              <td style="font-weight:700;">${merged}</td>
              <td>${topType}</td>
              <td class="muted">${escapeHtml(last)}</td>
              <td>${statusBadge(status)}</td>
            </tr>
          `;
        }).join("");
      }

      function renderActivityChart(ds) {
        const labels = (ds.series || []).map(x => x.date);
        const merged = (ds.series || []).map(x => Number(x.mergedPRs || 0));
        const active = (ds.series || []).map(x => Number(x.activeEngineers || 0));

        const ctx = document.getElementById("activity-chart");
        if (state.charts.activity) state.charts.activity.destroy();

        state.charts.activity = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: "Merged PRs", data: merged, tension: 0.35 },
              { label: "Active engineers", data: active, tension: 0.35 },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: "rgba(229,231,235,0.85)" } },
              tooltip: { mode: "index", intersect: false },
            },
            interaction: { mode: "index", intersect: false },
            scales: {
              x: {
                ticks: { color: "rgba(148,163,184,0.9)", maxRotation: 0, autoSkip: true },
                grid: { color: "rgba(148,163,184,0.12)" },
              },
              y: {
                ticks: { color: "rgba(148,163,184,0.9)" },
                grid: { color: "rgba(148,163,184,0.12)" },
              },
            },
          },
        });
      }

      function renderBreakdownChart(ds) {
        const isTeam = state.breakdownMode === "team";
        const map = isTeam ? (ds.teamMerged || {}) : (ds.typeMerged || {});
        const labels = Object.keys(map);
        const values = labels.map(k => Number(map[k] || 0));

        if (isTeam) {
          breakdownTitle.textContent = "Team breakdown";
          breakdownSubtitle.textContent = "Share of merged PRs.";
          breakdownNote.textContent = "Teams come from your directory mapping (or stored user team field).";
        } else {
          breakdownTitle.textContent = "Work type breakdown";
          breakdownSubtitle.textContent = "Share of merged PRs by PR tag.";
          breakdownNote.textContent = "Work types come from PR tags (e.g. Feature, Bug fix, Refactor).";
        }

        const ctx = document.getElementById("breakdown-chart");
        if (state.charts.breakdown) state.charts.breakdown.destroy();

        state.charts.breakdown = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets: [{ label: "Merged PRs", data: values }],
          },
          options: {
            plugins: {
              legend: { position: "bottom", labels: { color: "rgba(229,231,235,0.85)" } },
            },
          },
        });
      }

      function setBreakdownMode(mode) {
        state.breakdownMode = mode;
        breakdownTeamBtn.classList.toggle("active", mode === "team");
        breakdownTypeBtn.classList.toggle("active", mode === "type");
        if (state.dataset) renderBreakdownChart(state.dataset);
      }

      // -----------------------------
      // CSV export
      // -----------------------------
      function toCSV(rows) {
        const esc = (v) => `"${String(v ?? "").replaceAll('"', '""')}"`;
        return rows.map(r => r.map(esc).join(",")).join("\n");
      }

      function download(filename, text) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([text], { type: "text/csv;charset=utf-8" }));
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      function exportCsv(ds) {
        const q = (searchInput.value || "").trim().toLowerCase();
        let users = (ds.users || []).slice();
        if (q) {
          users = users.filter(u => `${u.name || ""} ${u.email || ""}`.toLowerCase().includes(q));
        }

        const rows = [
          ["name", "email", "team", "mergedPRs", "topWorkType", "lastActivityISO", "status"],
          ...users.map(u => [
            u.name || u.email || u.id || "",
            u.email || "",
            u.team || "",
            Number(u.mergedPRs || 0),
            u.topType || "",
            u.lastActivity || "",
            (Number(u.mergedPRs || 0) >= 1) ? "Active" : "Inactive",
          ]),
        ];

        const periodDays = Number(ds.periodDays || periodSelect.value || 14);
        download(`rapidreviewer-admin-metrics-${periodDays}d.csv`, toCSV(rows));
      }

      // -----------------------------
      // Load & render
      // -----------------------------
      async function loadAndRender() {
        setError("");

        const token = getToken();
        if (!token) {
          headerPill.textContent = "Not signed in";
          signInBtn.style.display = "inline-block";
          signOutBtn.style.display = "none";
          setError("No token found. Please sign in to view admin metrics.");
          clearUI();
          return;
        }

        headerPill.textContent = "Logged in via Cognito · Admin dashboard";
        signInBtn.style.display = "none";
        signOutBtn.style.display = "inline-block";

        const periodDays = Number(periodSelect.value || 14);
        const team = teamSelect.value || "all";

        try {
          headerPill.textContent = "Loading metrics…";
          const ds = await fetchAdminMetrics({ periodDays, team });

          state.dataset = ds;

          // Populate team selector from backend response
          setTeamOptions(ds.teams || []);

          // Render
          renderRange(ds);
          renderKpis(ds);
          renderActivityChart(ds);
          renderBreakdownChart(ds);
          renderUsersTable(ds);

          headerPill.textContent = "Logged in via Cognito · Admin dashboard";
        } catch (e) {
          console.error("Admin metrics error:", e);

          if (e.message === "missing_token") {
            setError("No token found. Please sign in.");
          } else if (e.status === 401) {
            setError("Unauthorized (401). Your session may be expired. Please sign in again.");
          } else if (e.status === 403) {
            setError("Forbidden (403). This account does not have admin access for this tenant.");
          } else {
            setError(`Failed to load admin metrics. ${e.message || "Unknown error"}`);
          }

          headerPill.textContent = "Error loading metrics";
          clearUI();
        }
      }

      // -----------------------------
      // Events
      // -----------------------------
      breakdownTeamBtn.addEventListener("click", () => setBreakdownMode("team"));
      breakdownTypeBtn.addEventListener("click", () => setBreakdownMode("type"));

      refreshBtn.addEventListener("click", () => loadAndRender());

      periodSelect.addEventListener("change", () => loadAndRender());
      teamSelect.addEventListener("change", () => loadAndRender());

      searchInput.addEventListener("input", () => {
        if (!state.dataset) return;
        renderUsersTable(state.dataset);
      });

      exportBtn.addEventListener("click", () => {
        if (!state.dataset) return;
        exportCsv(state.dataset);
        setSuccess("Exported CSV.");
      });

      signInBtn.addEventListener("click", signIn);
      signOutBtn.addEventListener("click", signOut);

      // -----------------------------
      // Init
      // -----------------------------
      // Note: your post-auth.html already persists id_token into localStorage as "idToken".
      // So visiting admin.html after auth should just work.
      loadAndRender();
    </script>
  </body>
</html>
